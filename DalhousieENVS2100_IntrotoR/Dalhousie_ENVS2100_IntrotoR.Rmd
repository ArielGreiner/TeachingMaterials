---
title: "Introduction to R + Mapping"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

ENVS2100: Introduction to R Lesson

The relevant code for this lesson is contained in the grey boxes below. 

During the lesson we will go through the code in order. The content at the very bottom of the document under '<<<EXTRA MATERIALS>>>' will not be covered during the lesson but is provided in case students are interested in any extra material.

CODING 101

```{r, results="hide"}
print("Hello World")

for(i in 1:10){
	print(i)
	if(i == 5){
		print("Halfway!")
	}
}

#this is a comment


numbers <- c(1,2,3)

1 == 1
1 != 2
1 < 2
3 > 1
1 <= 1
1 >= 0

greetings <- c("hello","goodbye","nice to meet you")

cats <- data.frame(cat_ID = c(1,2,3), cat_colour = c("brown","red","white"))
cats[1,] #first row
cats[,1] #first column
cats$cat_ID
cats$cat_colour[cats$cat_ID == 1]

mean(c(1,2,3,4))

```

LOADING PACKAGES
need to install ggplot2 + dependencies
```{r, results="hide"}

#need to choose a CRAN mirror to download from, I usually choose Ontario (in Canada)

#install.packages("ggplot2")
#make sure to install dependencies also!

library(ggplot2)

```

FINDING HELP
```{r, warning=FALSE, results="hide"}

?plot
??mutate #have not loaded in dplyr, so if searched this with just one '?' it would not work; this shows you all of the results from all of the packages with a function with this name

##ADD AN EXAMPLE ERROR MESSAGE AND HELP SITE THAT CAME UP

##Example Query: "How do I remove everything after the first number in a string?"
stringz <- c("LTER 1 Fringing Reef Coral Transect Pole 1-2 Quadrat 1", "LTER 2 Fringing Reef Coral Transect Pole 1-2 Quadrat 2","LTER 1 Fringing Reef Coral Transect Pole 1-2 Quadrat 3","LTER 3 Fringing Reef Coral Transect Pole 1-2 Quadrat 4", "LTER 1 Fringing Reef Coral Transect Pole 1-2 Quadrat 5","LTER 4 Fringing Reef Coral Transect Pole 1-2 Quadrat 6")
#this will involve using reg ex expressions (used for cutting/splicing strings), which I never remember so I always look up how to do this
#https://stackoverflow.com/questions/56612262/remove-string-after-first-number-using-r-regex the answer below came from here
small_stringz <- sub("^(\\D*\\d+).*", "\\1", stringz)
#"LTER 1" "LTER 2" "LTER 1" "LTER 3" "LTER 1" "LTER 4"

##What does 'rowSums' do?
rowSums #output below
#function (x, na.rm = FALSE, dims = 1L) 
#{
#    if (is.data.frame(x)) 
#        x <- as.matrix(x)
#    if (!is.array(x) || length(dn <- dim(x)) < 2L) 
#        stop("'x' must be an array of at least two dimensions")
#    if (dims < 1L || dims > length(dn) - 1L) 
#        stop("invalid 'dims'")
#    p <- prod(dn[-(id <- seq_len(dims))])
#    dn <- dn[id]
#    z <- if (is.complex(x)) 
#        .Internal(rowSums(Re(x), prod(dn), p, na.rm)) + (0+1i) * 
#            .Internal(rowSums(Im(x), prod(dn), p, na.rm))
#    else .Internal(rowSums(x, prod(dn), p, na.rm))
#    if (length(dn) > 1L) {
#        dim(z) <- dn
#        dimnames(z) <- dimnames(x)[id]
#    }
#    else names(z) <- dimnames(x)[[1L]]
#    z
#}
#<bytecode: 0x134666780>
#<environment: namespace:base>

#Can look at a large sample dataset that comes pre-loaded into R ('iris')
head(iris) #shows the first 6 rows of a dataframe
str(iris) #shows the general structure of the object and the data types included in each part of the object

```

LOAD IN THE DATA
Commands to load in + explore the dataset
```{r, results="hide"}
#The manual methods below are for Base R, if you are using RStudio let me know and I will show you how to do it 
#Manual Method (Windows): File -> Load Workspace -> go to where you downloaded the file -> Open the File
#Manual Method (Mac): Workspace -> Load Workspace File... -> go to where you downloaded the file -> Open the File

#General Method: Go to the file on your computer, right click on it to find the path, copy paste it in quotes into load(file = "")
#for windows: <NEED TO CHECK THIS, SOME WEIRD // SITUATION>
#for mac: should be able to just copy paste it straight in
#e.g. on my computer  
load(file = "~/Dropbox/Github/TeachingMaterials/DalhousieENVS2100_IntrotoR/avgdata_ENVS2100_IntrotoR.RData") 

#it will load in as 'avgdata'

#check that the file looks okay!
head(avgdata) 
str(avgdata)
names(avgdata) #column names
avgdata[,c(1,2)] #look at the first two columns

```

INFORMATION ABOUT THE DATA
Data Source
Moorea Coral Reef LTER and P. Edmunds. 2024. MCR LTER: Coral Reef: Long-term Population and Community Dynamics: Corals, ongoing since 2005 ver 40. Environmental Data Initiative. https://doi.org/10.6073/pasta/15d5120fb4f7b79811b16287eae15a35 (Accessed 2024-01-24).

BASIC DATA CLEANING
Want to Meld the two Hard Coral columns into one Hard Coral column. To see more advanced data cleaning, look below in the <<<EXTRA MATERIALS>>> section.
```{r, results="hide"}
head(avgdata) #look at the dataset again, to recall the format

avgdata$HardCoral <- avgdata$HardCoral_Other + avgdata$HardCoral_StressTol #this adds a hard coral column to the end of the dataset

head(avgdata) #see it here

```


SIMPLE PLOTS OF THE DATA
base plots vs ggplot plots

Base R plotting guide: http://www.sthda.com/english/wiki/r-base-graphs
ggplot plotting guide: https://rstudio.github.io/cheatsheets/html/data-visualization.html, https://datacarpentry.org/R-ecology-lesson/04-visualization-ggplot2.html
```{r, results="hide"}

#BASE R PLOTS

##Basic Scatter plot - Shows how hard coral cover changes over time in LTER 1
#try changing the site by changing "LTER 1" to another LTER or changing the benthic type by changing "HydroCoral" to "HardCoral_StressTol" or some other benthic type after the '$' sign in the response variable (y) 
plot(x = avgdata$Date[avgdata$Site == "LTER 1"], y = avgdata$HydroCoral[avgdata$Site == "LTER 1"], pch = 20, xlab = "Year", ylab = "Hard Coral Cover (Stress Tol)", main = "LTER 1")

#same plot as above, with a line marking 30% cover
plot(x = avgdata$Date[avgdata$Site == "LTER 1"], y = avgdata$HydroCoral[avgdata$Site == "LTER 1"], pch = 20, xlab = "Year", ylab = "Hard Coral Cover (Stress Tol)", main = "LTER 1", ylim=c(0,1))
abline(h=0.3, col = "red") 

#can also plot another benthic variable on the same plot using points()
plot(x = avgdata$Date[avgdata$Site == "LTER 1"], y = avgdata$HydroCoral[avgdata$Site == "LTER 1"], pch = 20, xlab = "Year", ylab = "Hard Coral Cover (Stress Tol)", main = "LTER 1", ylim=c(0,1))
points(x = avgdata$Date[avgdata$Site == "LTER 1"], y = avgdata$Macroalgae[avgdata$Site == "LTER 1"], pch = 20, col = "blue")
abline(h=0.3, col = "red") 
#NOTE TO ARIEL: ADD LEGEND HERE

##Basic Scatter plot - Shows how hard coral cover varies across space in 2005
#try changing the year by changing 2005 to another year or changing the benthic type by changing "HardCoral_StressTol" to "Sand" or some other benthic type after the '$' sign in the response variable (y) 
#as.factor() changes that vector into a factor variable, enabling it to be plotted along the x-axis since factor variables are ordered character variables  
plot(x = as.factor(avgdata$Site[avgdata$Date == 2005]), y = avgdata$HardCoral_StressTol[avgdata$Date == 2005], xlab = "Site", ylab = "Hard Coral Cover (Stress Tol)", main = "2005")
#NOTE TO ARIEL: ADD MORE TYPES OF BASE PLOTS

#GGPLOTS

#you can make very similar plots using ggplot! 
library(ggplot2)

##Basic Scatter plot - Shows how hard coral cover changes over time in LTER 1
#try changing the site by changing "LTER 1" to another LTER or changing the benthic type by changing "y = HydroCoral" to "y = HardCoral_StressTol" or some other benthic type 
ggplot(aes(x = Date, y = HydroCoral), data = avgdata[avgdata$Site == "LTER 1",])+
  ggtitle("LTER 1")+ #add '+' to indicate that you're adding another element to the plot
  geom_point()

#same plot as above, with a line marking 30% cover
#couldn't remember how to do this, so looked up 'add horizontal line to ggplot' and found http://www.sthda.com/english/wiki/ggplot2-add-straight-lines-to-a-plot-horizontal-vertical-and-regression-lines 
ggplot(aes(x = Date, y = HydroCoral), data = avgdata[avgdata$Site == "LTER 1",])+
  ggtitle("LTER 1")+ #add '+' to indicate that you're adding another element to the plot
  geom_point()+
  geom_hline(yintercept = 0.3, col = "red")

#can also plot another benthic variable on the same plot by adding another geom_point() line
ggplot(aes(x = Date, y = HydroCoral), data = avgdata[avgdata$Site == "LTER 1",])+
  ggtitle("LTER 1")+ #add '+' to indicate that you're adding another element to the plot
  geom_point()+
  geom_point(aes(x = Date, y = Macroalgae), col = "blue")+
  geom_hline(yintercept = 0.3, col = "red")
#NOTE TO ARIEL: ADD LEGEND HERE
  
##Basic Scatter plot - Shows how hard coral cover varies across space in 2005
#try changing the year by changing 2005 to another year or changing the benthic type by changing "y = HydroCoral" to " y = HardCoral_StressTol" or some other benthic type 
ggplot(aes(x = Site, y = HydroCoral), data = avgdata[avgdata$Date == 2005,])+
  ggtitle("2005")+ #add '+' to indicate that you're adding another element to the plot
  geom_point()



```


SPATIAL VISUALIZATION OF THE DATA 
```{r, results="hide"}
library(maps) #CHECK IF THIS IS A DEPENDENCY IN GGPLOT2
library(ggplot2)

#NOT WORKING YET
#this plot is a bit more advanced, but you can still play around with it by changing which benthic type determines the colouration by changing 'colour' of geom_point below

#correct the longitude


```


ANSWER SOME QUESTIONS WITH THIS DATA
- How does hard coral cover change over time? Stress tolerant hard coral cover?
- 30% or over?
- Spatial Variation?


<<<EXTRA MATERIALS>>>

DATA CLEANING
The code below here shows how I took the data that I downloaded directly from the LTER website and edited it to be more manageable for this lesson.

The initial data 'knb-lter-mcr.4_2_20240105.csv' was downloaded from 
https://portal.edirepository.org/nis/mapbrowse?packageid=knb-lter-mcr.4.40, by clicking on the "2. Percent Cover - Wide Table" download.

```{r,warning=FALSE, results="hide"}
setwd("~/Dropbox/Github/TeachingMaterials/DalhousieENVS2100_IntrotoR/")

#Load in the .csv file (made reference to: https://teacherscollege.screenstepslive.com/a/1122473-import-data-in-r-csv-files-into-r-studio)
initialdata <- read.csv("knb-lter-mcr.4_2_20240105.csv") #Full path: "~/Dropbox/Github/TeachingMaterials/DalhousieENVS2100_IntrotoR/knb-lter-mcr.4_2_20240105.csv"

names(initialdata) #look at the original column names

#R does not recognize 'na' as NA's, need to change them to a format R recognizes
dummy <- initialdata #just in case
initialdata[initialdata == "na"] <- NA #threw some error messages but it worked

#most of the columns are characters (same for dummy), it's going to be much easier to work with the columns with numbers in them if they are numeric
str(initialdata) 
for(i in 3:34){ #there are more efficient ways to do this but since I only have to do this once, doing it the inefficient way
  initialdata[,i] <- as.numeric(initialdata[,i])
}

#want to check if all of the rows sum to the same thing, to check my understanding of what this dataset is 
#can do that using rowSums (https://www.statology.org/rowsums-function-in-r/) and range() to check what the range of values are
range(rowSums(initialdata[,3:34], na.rm=T)) #0.0 1119.4, but most of them seem to be around 1090.9; so it seems like these are vaguely percent cover values

##going to make a handful of new columns and just put them at the end of the set of columns, for simplicity. Will move them around later.
#make a site column that just has 'LTER X' in it
#this will involve using reg ex expressions (used for cutting/splicing strings), which I never remember so I always look up how to do this
#https://stackoverflow.com/questions/56612262/remove-string-after-first-number-using-r-regex this answer came from here
initialdata$Site <- sub("^(\\D*\\d+).*", "\\1", initialdata$Location)

##add geographic coordinates to all of the sites
#levels(as.factor(initialdata$Site)) #this is a trick that I use when I know that a column contains only a handful of different strings and I want to know what they all are quickly. It is also handy as a troubleshooting method.
#can use it to extract the site codes easily
sites <- levels(as.factor(initialdata$Site)) #"LTER 1" "LTER 2" "LTER 3" "LTER 4" "LTER 5" "LTER 6"
#geographic coordinates given as north, south, east, west -> but i just want the centroid, so take the average of the N/S one (latitude) and E/W one (longitude)
initialdata$Site_Latitude <- NA
initialdata$Site_Longitude <- NA

lat_sites <- c(((-17.47185366-17.48641792)/2), 
               ((-17.46576169-17.48131958)/2), 
               ((-17.50382025-17.52087158)/2), 
               ((-17.53305021-17.55064263)/2),
               ((-17.56818162-17.59182383)/2),
               ((-17.50735955-17.52839766)/2))
long_sites <- c(((-149.8455917-149.829821)/2),
                ((-149.8116849-149.7961685)/2),
                ((-149.7708619-149.7519968)/2),
                ((-149.7772857-149.7566866)/2),
                ((-149.8869755-149.8561009)/2),
                ((-149.934537-149.9115336)/2))

for(i in 1:length(sites)){
  initialdata$Site_Latitude[initialdata$Site == sites[i]] <- lat_sites[i]
  initialdata$Site_Longitude[initialdata$Site == sites[i]] <- long_sites[i]
}

##convert the numbers in columns 3-34 to percentages of a total
#need a sum column first, see above for the code for that 
initialdata$totalcover <- rowSums(initialdata[,3:34], na.rm=T)

#making a new dataframe to make this a bit easier and to ensure that things are organized a bit more sensibly
#note: redefining CTB and Non_Coralline_Crustose_Algae as 'SmallAlgae_orBare', this isn't a perfect categorization but should suffice here 
#to do this, need to make a vector of these two being added together that treats the NA's properly
SmallAlgaeorBare <- rowSums(initialdata[,4:5], na.rm=T)
#dividing all of the columns with data by the total to turn them into proportions of the total
nonavg_data <- data.frame(Date = initialdata$Date, Site = initialdata$Site, Latitude = initialdata$Site_Latitude, Longitude = initialdata$Site_Longitude, HardCoral_Other = NA, HardCoral_StressTol = NA, Macroalgae = initialdata$Macroalgae/initialdata$totalcover, SoftCoral = initialdata$Soft_Coral/initialdata$totalcover, HydroCoral = initialdata$Millepora/initialdata$totalcover, SmallAlgae_orBare = (SmallAlgaeorBare)/initialdata$totalcover, Sand = initialdata$Sand/initialdata$totalcover, Unknown_or_Other = initialdata$Unknown_or_Other/initialdata$totalcover) 
#convert the hard coral data into 'stress tolerant hard coral' and 'other hard coral'
#referred to this paper to organize the genera: https://onlinelibrary.wiley.com/doi/full/10.1111/j.1461-0248.2012.01861.x 
nonavg_data$HardCoral_Other <- rowSums(initialdata[,c(9,10,15,16,17,18,22,25,26,27,28,30,31,32,33)], na.rm = T)
nonavg_data$HardCoral_StressTol <- rowSums(initialdata[,c(8,11,12,13,14,19,21,23,24,29)], na.rm = T)
#turning these into proportions also
nonavg_data$HardCoral_Other <- nonavg_data$HardCoral_Other/initialdata$totalcover
nonavg_data$HardCoral_StressTol <- nonavg_data$HardCoral_StressTol/initialdata$totalcover

#checking: range(rowSums(nonavg_data[,5:12], na.rm=T)) #range = 0-1, checked that they're all either 0 or 1 which is fair
checking <- rowSums(nonavg_data[,5:12], na.rm=T)
#some 0s in checking[9936:10936], these are from situations where the cover value is listed as 0

#take the average of all of the quadrats for each site for each year
years <- seq(2005,2022,1)
avgdata <- data.frame(Date = rep(years, each = length(sites)), Site = rep(sites,length(years)), Latitude = lat_sites, Longitude = long_sites, HardCoral_Other = NA, HardCoral_StressTol = NA, HydroCoral = NA, Macroalgae = NA, SoftCoral = NA, SmallAlgae_orBare = NA, Sand = NA, Unknown_or_Other = NA) 

for(i in 1:length(years)){
  for(j in 1:length(sites)){
    avgdata$HardCoral_Other[avgdata$Date == years[i] & avgdata$Site == sites[j]] <- mean(nonavg_data$HardCoral_Other[nonavg_data$Date == years[i] & nonavg_data$Site == sites[j]], na.rm = T)
    avgdata$HardCoral_StressTol[avgdata$Date == years[i] & avgdata$Site == sites[j]] <- mean(nonavg_data$HardCoral_StressTol[nonavg_data$Date == years[i] & nonavg_data$Site == sites[j]], na.rm = T)
     avgdata$HydroCoral[avgdata$Date == years[i] & avgdata$Site == sites[j]] <- mean(nonavg_data$HydroCoral[nonavg_data$Date == years[i] & nonavg_data$Site == sites[j]], na.rm = T)
    avgdata$Macroalgae[avgdata$Date == years[i] & avgdata$Site == sites[j]] <- mean(nonavg_data$Macroalgae[nonavg_data$Date == years[i] & nonavg_data$Site == sites[j]], na.rm = T)
    avgdata$SoftCoral[avgdata$Date == years[i] & avgdata$Site == sites[j]] <- mean(nonavg_data$SoftCoral[nonavg_data$Date == years[i] & nonavg_data$Site == sites[j]], na.rm = T)
    avgdata$SmallAlgae_orBare[avgdata$Date == years[i] & avgdata$Site == sites[j]] <- mean(nonavg_data$SmallAlgae_orBare[nonavg_data$Date == years[i] & nonavg_data$Site == sites[j]], na.rm = T)
    avgdata$Sand[avgdata$Date == years[i] & avgdata$Site == sites[j]] <- mean(nonavg_data$Sand[nonavg_data$Date == years[i] & nonavg_data$Site == sites[j]], na.rm = T)
    avgdata$Unknown_or_Other[avgdata$Date == years[i] & avgdata$Site == sites[j]] <- mean(nonavg_data$Unknown_or_Other[nonavg_data$Date == years[i] & nonavg_data$Site == sites[j]], na.rm = T)
  }
}

#just for simplicity, im going to recode the NaN's in this dataset as 0s because I do not know what they are but they will make things harder for the students if I leave them in
#used this https://www.statology.org/nan-in-r/ to figure out how to do this
avgdata$SoftCoral[which(is.na(avgdata$SoftCoral))] <- 0
avgdata$Unknown_or_Other[which(is.na(avgdata$Unknown_or_Other))] <- 0

#now save this final dataset
save(avgdata, file = "avgdata_ENVS2100_IntrotoR.RData")
#https://datatofish.com/export-dataframe-to-csv-in-r/ 
write.csv(avgdata, file = "avgdata_ENVS2100_IntrotoR.csv")

```

NOTES
geographic coordinates verification: https://portal.edirepository.org/nis/metadataviewer?packageid=knb-lter-mcr.4.40

It's often easier to code in RStudio, you can download that here: https://posit.co/download/rstudio-desktop/ 

